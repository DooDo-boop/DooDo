<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DooDo v0.2 (Pinch Enabled)</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { 
      width:100%; height:100%; 
      overflow:hidden;
      touch-action:none;
    }
    body { 
      background: #E594BF;
      font-family: sans-serif;
      position:fixed;
    }
    #palette {
      display:flex; background:#fff; padding:8px;
      gap:12px; align-items:center;
      position:relative;
      z-index:10;
    }
    .shape-icon, .color-swatch {
      width:32px; height:32px;
      border:2px solid #ccc; border-radius:4px;
      display:flex; justify-content:center; align-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .color-swatch { border-radius:50%; }
    #canvas {
      position:fixed;
      width:100vw; 
      height:calc(100vh - 52px);
      top:52px;
      left:0;
      overflow:hidden;
    }
    .canvas-shape {
      position:absolute; 
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
      transform-origin: center center;
    }
  </style>
</head>
<body>
  <div id="palette">
    <div id="shape-palette">
      <div class="shape-icon" data-shape="circle">◯</div>
      <div class="shape-icon" data-shape="rect">◻︎</div>
      <div class="shape-icon" data-shape="triangle">△</div>
    </div>
    <div id="color-palette">
      <div class="color-swatch" data-color="#2E3192" style="background:#2E3192;"></div>
      <div class="color-swatch" data-color="rgba(237,28,36,0.56)" style="background:rgba(237,28,36,0.56);"></div>
      <div class="color-swatch" data-color="#FAF073" style="background:#FAF073;"></div>
    </div>
  </div>
  <div id="canvas"></div>

  <script>
    const shapeSVGs = {
      circle: '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><circle cx="40" cy="40" r="40"/></svg>',
      rect: '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="80" height="80"/></svg>',
      triangle: '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><polygon points="40,0 80,80 0,80"/></svg>'
    };

    const canvas = document.getElementById('canvas');
    let selectedColor = '#2E3192';

    // Add color palette handler
    document.querySelectorAll('.color-swatch').forEach(s => {
      s.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.color-swatch').forEach(x=>x.style.border='2px solid #ccc');
        s.style.border = '2px solid #000';
        selectedColor = s.dataset.color;
      });
    });

    // Add shape palette handler
    document.querySelectorAll('.shape-icon').forEach(icon => {
      icon.addEventListener('click', (e) => {
        e.preventDefault();
        
        const shapeKey = icon.dataset.shape;
        const div = document.createElement('div');
        div.className = 'canvas-shape';
        div.innerHTML = shapeSVGs[shapeKey];
        
        // Center the shape
        const rect = canvas.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        div.style.left = `${centerX - 40}px`;
        div.style.top = `${centerY - 40}px`;
        div.style.fill = selectedColor;
        canvas.appendChild(div);

        // Initialize transform properties
        div._scale = 1;
        div._rot = 0;
        div._currentScale = 1;
        div._currentRot = 0;

        // Touch/pointer event handling
        let isDragging = false;
        let isPinching = false;
        let startX, startY, origX, origY;
        let startDist, startAngle, origScale, origRotate;

        const handleStart = (e) => {
          e.preventDefault();
          const touches = e.touches || [e];
          
          if (touches.length === 1) {
            isDragging = true;
            startX = touches[0].clientX;
            startY = touches[0].clientY;
            origX = parseFloat(div.style.left);
            origY = parseFloat(div.style.top);
          } else if (touches.length === 2) {
            isPinching = true;
            startDist = getDist(touches);
            startAngle = getAngle(touches);
            origScale = div._scale || 1;
            origRotate = div._rot || 0;
          }
          
          if(e.pointerId !== undefined) {
            div.setPointerCapture(e.pointerId);
          }
        };
        
        const handleMove = (e) => {
          e.preventDefault();
          const touches = e.touches || [e];
          
          if (touches.length === 1 && isDragging) {
            const dx = touches[0].clientX - startX;
            const dy = touches[0].clientY - startY;
            div.style.left = `${origX + dx}px`;
            div.style.top = `${origY + dy}px`;
          } 
          else if (touches.length === 2 && isPinching) {
            const newDist = getDist(touches);
            const newAngle = getAngle(touches);
            const scale = origScale * (newDist / startDist);
            const rotate = origRotate + (newAngle - startAngle);
            applyTransform(div, scale, rotate);
          }
        };
        
        const handleEnd = (e) => {
          isDragging = false;
          isPinching = false;
          if (div._currentScale) div._scale = div._currentScale;
          if (div._currentRot) div._rot = div._currentRot;
          
          if(e.pointerId !== undefined) {
            div.releasePointerCapture(e.pointerId);
          }
        };

        // Helper functions
        function getDist(touches) {
          const dx = touches[0].clientX - touches[1].clientX;
          const dy = touches[0].clientY - touches[1].clientY;
          return Math.hypot(dx, dy);
        }

        function getAngle(touches) {
          const dx = touches[1].clientX - touches[0].clientX;
          const dy = touches[1].clientY - touches[0].clientY;
          return Math.atan2(dy, dx) * (180 / Math.PI);
        }

        function applyTransform(el, scale, rotation) {
          const currentX = parseFloat(el.style.left) + 40;
          const currentY = parseFloat(el.style.top) + 40;
          el.style.transform = `translate(0,0) scale(${scale}) rotate(${rotation}deg)`;
          el._currentScale = scale;
          el._currentRot = rotation;
        }

        // Add event listeners
        div.addEventListener('touchstart', handleStart, { passive: false });
        div.addEventListener('touchmove', handleMove, { passive: false });
        div.addEventListener('touchend', handleEnd);
        div.addEventListener('pointerdown', handleStart);
        div.addEventListener('pointermove', handleMove);
        div.addEventListener('pointerup', handleEnd);
        div.addEventListener('pointercancel', handleEnd);
      });
    });
  </script>
</body>
</html>